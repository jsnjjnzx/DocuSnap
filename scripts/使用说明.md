# DocuSnap 打包与发布指南

本文档说明如何使用提供的脚本进行扩展的打包和发布。

## 📦 打包扩展

### 使用打包脚本

**推荐方式**：使用批处理脚本（.bat 文件）

双击运行 `scripts/package.bat` 或在命令行中执行：

```cmd
cd scripts
package.bat
```

**注意**：如果使用 PowerShell 脚本（.ps1 文件）遇到执行策略限制，请使用批处理脚本或参考下方的解决方案。

### 打包流程

脚本会自动执行以下步骤：

1. **检查依赖**: 如果 `node_modules` 不存在，自动运行 `npm install`
2. **编译代码**: 运行 `npm run compile` 编译 TypeScript
3. **生成 VSIX**: 运行 `npm run package` 打包扩展

### 打包结果

成功后会在项目根目录生成 `.vsix` 文件：
```
docusnap-assets-1.0.0.vsix
```

### 本地安装测试

打包完成后，可以通过以下方式安装测试：

**方法 1: VS Code 界面**
1. 打开 VS Code
2. 进入扩展视图 (Ctrl+Shift+X)
3. 点击右上角的 `...` 菜单
4. 选择"从 VSIX 安装..."
5. 选择生成的 `.vsix` 文件

**方法 2: 命令行**
```cmd
code --install-extension docusnap-assets-1.0.0.vsix
```

## 🚀 发布到市场

### 前置准备

在首次发布前，需要完成以下准备工作：

#### 1. 创建 Azure DevOps 账号

1. 访问 [Azure DevOps](https://dev.azure.com/)
2. 使用 Microsoft 账号登录或注册

#### 2. 创建发布者账号

1. 访问 [Visual Studio Marketplace 发布者管理](https://marketplace.visualstudio.com/manage)
2. 点击"Create publisher"
3. 填写发布者信息：
   - **ID**: `jsnjjnzx` (必须与 package.json 中的 publisher 一致)
   - **Display Name**: 显示名称
   - **Description**: 描述

#### 3. 生成 Personal Access Token (PAT)

1. 访问 [Azure DevOps](https://dev.azure.com/)
2. 点击右上角用户图标 > "Personal access tokens"
3. 点击"New Token"
4. 配置 Token：
   - **Name**: 任意名称，如 "VSCode Extension Publishing"
   - **Organization**: 选择你的组织
   - **Expiration**: 建议选择较长期限（如 90 天或自定义）
   - **Scopes**: 选择 "Custom defined"
   - 展开 "Marketplace" 并勾选 **"Manage"** 权限
5. 点击"Create"
6. **重要**: 复制生成的 Token（只显示一次，请妥善保存）

#### 4. 使用 Token 登录

在命令行中执行：

```cmd
npx vsce login jsnjjnzx
```

系统会提示输入 Personal Access Token，粘贴刚才生成的 Token。

### 使用发布脚本

完成上述准备后，双击运行 `scripts/publish.bat` 或在命令行中执行：

```cmd
cd scripts
publish.bat
```

**注意**：
1. 脚本会要求输入 `YES` 确认发布，这是为了防止误操作
2. 如果使用 PowerShell 脚本遇到问题，请使用批处理脚本
3. 首次发布建议先运行 `test-build.bat` 检查环境

### 发布流程

脚本会执行以下步骤：

1. **检查登录状态**: 验证是否已登录发布者账号
2. **确认发布**: 显示版本信息并要求输入 `YES` 确认
3. **编译代码**: 运行 `npm run compile`
4. **打包扩展**: 运行 `npm run package`
5. **发布到市场**: 运行 `npm run publish`

### 发布确认

脚本会显示以下信息供你确认：

```
当前发布者: jsnjjnzx
扩展名称: docusnap-assets
版本: 1.0.0

警告: 此操作将发布扩展到 VS Code 市场
发布后无法撤销，请确认以下内容:
  1. 版本号正确 (package.json)
  2. CHANGELOG.md 已更新
  3. README.md 内容完整
  4. 代码已测试通过

确认发布? (输入 YES 继续):
```

输入 `YES` 后继续发布流程。

### 发布后

发布成功后，脚本会显示：

```
========================================
发布成功！
========================================

扩展已发布到 VS Code 市场
市场链接: https://marketplace.visualstudio.com/items?itemName=jsnjjnzx.docusnap-assets

注意: 市场审核可能需要几分钟到几小时
您可以在上述链接查看发布状态
```

## 🔄 版本更新流程

发布新版本时，请按以下步骤操作：

### 1. 更新版本号

编辑 `package.json`，修改 `version` 字段：

```json
{
  "version": "1.1.0"  // 从 1.0.0 更新到 1.1.0
}
```

版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范：
- **主版本号 (Major)**: 不兼容的 API 修改
- **次版本号 (Minor)**: 向下兼容的功能性新增
- **修订号 (Patch)**: 向下兼容的问题修正

### 2. 更新 CHANGELOG

在 `CHANGELOG.md` 顶部添加新版本的更新内容：

```markdown
## [1.1.0] - 2025-01-15

### 新增
- 添加了 XXX 功能

### 修复
- 修复了 XXX 问题

### 改进
- 优化了 XXX 性能
```

### 3. 测试

确保所有功能正常工作：
- 本地测试扩展功能
- 运行 `npm run compile` 确保无编译错误
- 使用 `package.bat` 打包并本地安装测试

### 4. 提交代码

```bash
git add .
git commit -m "chore: bump version to 1.1.0"
git push
```

### 5. 发布新版本

运行发布脚本：

```cmd
cd scripts
publish.bat
```

## ⚠️ 常见问题

### 问题 0: PowerShell 脚本无法运行

**错误信息**:
```
无法加载文件，因为在此系统上禁止运行脚本
```

**解决方案 1**（推荐）：使用批处理脚本
```cmd
package.bat
publish.bat
```

**解决方案 2**：临时允许 PowerShell 脚本
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
.\package.ps1
```

**解决方案 3**：永久修改执行策略（需要管理员权限）
```powershell
# 以管理员身份运行 PowerShell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 问题 1: 未登录错误

**错误信息**:
```
错误: 未找到发布者凭据
```

**解决方案**:
```cmd
npx vsce login jsnjjnzx
```
然后输入你的 Personal Access Token。

### 问题 2: Token 过期

**错误信息**:
```
Error: Failed request: (401)
```

**解决方案**:
1. 在 Azure DevOps 中生成新的 PAT
2. 重新登录：`npx vsce login jsnjjnzx`

### 问题 3: 版本号冲突

**错误信息**:
```
Error: Extension version X.X.X already exists
```

**解决方案**:
1. 更新 `package.json` 中的版本号
2. 确保版本号大于已发布的版本

### 问题 4: 编译失败

**错误信息**:
```
错误: 编译失败
```

**解决方案**:
1. 检查 TypeScript 代码是否有语法错误
2. 运行 `npm install` 确保依赖完整
3. 查看详细错误信息并修复

### 问题 5: 打包失败

**错误信息**:
```
错误: 打包失败
```

**解决方案**:
1. 确保 `vsce` 已安装：`npm install -g vsce`
2. 检查 `package.json` 配置是否正确
3. 确保所有必需文件存在（README.md, LICENSE 等）

## 📋 发布检查清单

在发布前，请确认以下事项：

- [ ] 版本号已更新（package.json）
- [ ] CHANGELOG.md 已更新
- [ ] README.md 内容完整准确
- [ ] 所有功能已测试通过
- [ ] 代码已提交到 Git
- [ ] 已登录发布者账号
- [ ] Personal Access Token 未过期
- [ ] 编译无错误
- [ ] 本地打包测试通过

## 🔗 相关链接

- [VS Code 扩展发布文档](https://code.visualstudio.com/api/working-with-extensions/publishing-extension)
- [vsce 命令行工具](https://github.com/microsoft/vscode-vsce)
- [Azure DevOps](https://dev.azure.com/)
- [Visual Studio Marketplace](https://marketplace.visualstudio.com/)
- [语义化版本规范](https://semver.org/lang/zh-CN/)

## 💡 提示

1. **首次发布**: 市场审核可能需要几分钟到几小时
2. **版本更新**: 更新通常会更快，但仍需等待审核
3. **Token 安全**: 不要将 PAT 提交到代码仓库
4. **版本规划**: 合理规划版本号，避免频繁发布小更新
5. **测试充分**: 发布前务必充分测试，发布后无法撤销

---

祝发布顺利！🎉
