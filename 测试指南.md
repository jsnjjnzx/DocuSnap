# DocuSnap 测试指南

## 概述

本项目包含完整的自动化测试套件，用于确保插件功能的正确性和稳定性。

## 测试架构

```
test/
├── unit/                    # 单元测试（不需要 VSCode 环境）
│   └── pathUtils.test.ts   # 路径处理工具测试
├── suite/                   # 集成测试（需要 VSCode 环境）
│   ├── index.ts            # 测试运行器
│   ├── extension.test.ts   # 扩展基础功能测试
│   ├── hover.test.ts       # 悬浮预览测试
│   └── linkScanning.test.ts # 链接扫描测试
├── runTest.ts              # 测试启动器
└── README.md               # 测试文档
```

## 快速开始

### 1. 安装依赖
```bash
npm install
```

### 2. 运行所有测试
```bash
# 运行单元测试（快速）
npm run test:unit

# 运行集成测试（需要启动 VSCode）
npm test
```

## 测试类型详解

### 单元测试
**特点：**
- 运行速度快（毫秒级）
- 不需要 VSCode 环境
- 测试纯函数和工具方法
- 使用 Mocha + Chai

**适用场景：**
- 路径处理函数
- 字符串解析
- 数据转换
- 配置解析

**示例：**
```typescript
describe('路径规范化', () => {
  it('应该移除前导斜杠', () => {
    expect(normalizeRel('./images/test.png')).to.equal('images/test.png');
  });
});
```

### 集成测试
**特点：**
- 在真实 VSCode 环境中运行
- 测试与 VSCode API 的交互
- 可以测试 UI 和命令
- 运行时间较长（秒级）

**适用场景：**
- 命令注册和执行
- 悬浮提示
- 文档操作
- 配置读取

**示例：**
```typescript
suite('扩展测试', () => {
  test('命令应该被注册', async () => {
    const commands = await vscode.commands.getCommands();
    assert.ok(commands.includes('docusnap.insertImage'));
  });
});
```

## 测试覆盖的功能

### ✅ 已测试功能

#### 1. 扩展基础
- [x] 扩展激活
- [x] 命令注册（16 个命令）
- [x] 配置项存在性验证
- [x] 默认配置值验证

#### 2. 路径处理
- [x] 路径规范化（移除 `./`、`/`，转换反斜杠）
- [x] WSL 环境检测
- [x] Windows 路径 → WSL 路径转换
- [x] WSL 路径 → Windows 路径转换

#### 3. 注释规则
- [x] 规则解析（`{ext1,ext2}-{token}` 格式）
- [x] 多规则支持
- [x] 无效规则处理
- [x] 空值处理

#### 4. 悬浮预览
- [x] @link@ 标记识别
- [x] 悬浮提示生成
- [x] 图片预览内容

#### 5. 链接扫描
- [x] 工作区文件扫描
- [x] 链接正则匹配
- [x] 有效/无效链接识别
- [x] 多种引号格式支持（无引号、单引号、双引号、反引号）

### 🚧 待测试功能

#### 1. 剪贴板功能
- [ ] 图片导出（需要模拟 PowerShell）
- [ ] 文件列表读取
- [ ] WSL 环境下的剪贴板访问

#### 2. 智能粘贴
- [ ] 剪贴板内容检测
- [ ] 三选一对话框
- [ ] 文件重命名
- [ ] 路径转换

#### 3. 文件操作
- [ ] 复制文件到 assets 目录
- [ ] 文件名冲突处理
- [ ] 删除无效链接
- [ ] 清理孤立附件

#### 4. UI 组件
- [ ] 侧边栏树视图
- [ ] WebView 预览面板
- [ ] 快速选择对话框
- [ ] 输入框验证

## 运行特定测试

### 运行单个测试文件
```bash
# 单元测试
npx mocha --require ts-node/register test/unit/pathUtils.test.ts

# 集成测试（需要通过 VSCode 测试运行器）
# 在 VSCode 中打开测试文件，点击 "Run Test" 按钮
```

### 使用 VSCode 调试
1. 打开 VSCode
2. 按 `F5` 或点击"运行和调试"
3. 选择 "Extension Tests"
4. 在测试文件中设置断点
5. 开始调试

## 编写新测试的最佳实践

### 1. 测试命名
```typescript
// ✅ 好的命名
test('应该在插入链接时创建 assets 目录', async () => {});

// ❌ 不好的命名
test('test1', async () => {});
```

### 2. 测试隔离
```typescript
suite('我的测试套件', () => {
  let tempDir: string;
  
  // 每个测试套件前执行一次
  suiteSetup(async () => {
    tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'test-'));
  });
  
  // 每个测试套件后执行一次
  suiteTeardown(() => {
    if (fs.existsSync(tempDir)) {
      fs.rmSync(tempDir, { recursive: true });
    }
  });
  
  test('测试 1', () => {
    // 使用 tempDir
  });
});
```

### 3. 异步处理
```typescript
// ✅ 正确处理异步
test('应该等待命令完成', async () => {
  const result = await vscode.commands.executeCommand('docusnap.insertImage');
  assert.ok(result);
});

// ❌ 忘记 await
test('错误示例', async () => {
  vscode.commands.executeCommand('docusnap.insertImage'); // 没有 await
  // 测试可能在命令完成前就结束了
});
```

### 4. 断言清晰
```typescript
// ✅ 清晰的断言消息
assert.strictEqual(result, expected, '返回值应该等于期望值');

// ❌ 没有消息
assert.strictEqual(result, expected);
```

## 持续集成

项目配置了 GitHub Actions，会在以下情况自动运行测试：
- 推送到 main/master/develop 分支
- 创建 Pull Request
- 在多个操作系统上测试（Ubuntu、Windows、macOS）
- 在多个 Node.js 版本上测试（18.x、20.x）

查看测试结果：
1. 访问 GitHub 仓库
2. 点击 "Actions" 标签
3. 查看最新的工作流运行

## 故障排查

### 问题：测试超时
**解决方案：**
```typescript
suite('慢速测试', function() {
  this.timeout(10000); // 设置 10 秒超时
  
  test('需要更长时间', async () => {
    // 测试代码
  });
});
```

### 问题：找不到模块
**解决方案：**
```bash
# 清理并重新安装
rm -rf node_modules package-lock.json
npm install
npm run compile
```

### 问题：VSCode 测试窗口不显示
**解决方案：**
1. 确保已编译：`npm run compile`
2. 检查 `out/test` 目录是否存在
3. 重启 VSCode

### 问题：WSL 环境测试失败
**原因：** 剪贴板功能需要 Windows PowerShell

**解决方案：**
- 确保 WSL 可以访问 `powershell.exe`
- 跳过剪贴板相关测试，或使用 mock

## 性能基准

在标准开发机器上的预期运行时间：

| 测试类型 | 测试数量 | 运行时间 |
|---------|---------|---------|
| 单元测试 | ~20 个 | < 1 秒 |
| 集成测试 | ~10 个 | 10-30 秒 |
| 完整测试套件 | ~30 个 | 30-60 秒 |

## 贡献测试

欢迎贡献新的测试用例！请遵循以下步骤：

1. **确定测试类型**
   - 纯函数 → 单元测试
   - VSCode 交互 → 集成测试

2. **创建测试文件**
   ```bash
   # 单元测试
   test/unit/myFeature.test.ts
   
   # 集成测试
   test/suite/myFeature.test.ts
   ```

3. **编写测试**
   - 遵循现有测试的风格
   - 添加清晰的注释
   - 确保测试可以独立运行

4. **运行测试**
   ```bash
   npm run compile
   npm run test:unit
   npm test
   ```

5. **提交代码**
   - 确保所有测试通过
   - 在 PR 中说明新增的测试覆盖

## 参考资源

- [VSCode 扩展测试文档](https://code.visualstudio.com/api/working-with-extensions/testing-extension)
- [Mocha 测试框架](https://mochajs.org/)
- [Chai 断言库](https://www.chaijs.com/)
- [@vscode/test-electron](https://github.com/microsoft/vscode-test)

## 联系方式

如有测试相关问题，请：
1. 查看 [test/README.md](test/README.md)
2. 提交 Issue 到 GitHub
3. 查看现有测试代码作为参考
